stages:
  - build
  - package
  - run
  - histograms
  - test
  - upload  

variables:
  WORKDIR: "/builds/atlas-phys/exot/ueh/EXOT-2017-19/DHNLAlgorithm"
  CERN_BOX_URL: "root://eosuser.cern.ch//eos/user/d/dhnl/algorithm-ci"

# build_code:
#   stage: build
#   image: atlas/analysisbase:21.2.90
#   variables:
#     GIT_SUBMODULE_STRATEGY: recursive
#   before_script:
#     - source /home/atlas/release_setup.sh
#     # Need to remove extra xAH from FactoryTools
#     - cd source/DHNLAlgorithm/deps/DVAnalysisBase/
#     - source util/dependencyHack.sh
#     - cd ../../../../
#     - mkdir build
#     - cd build
#   script:
#     - cmake ../source/
#     - cmake --build .
#   after_script:
#     - source "${AnalysisBase_PLATFORM}/setup.sh"
# #   only:
# #     changes:
# #       - source
#   artifacts:
#     paths:
#       - build
#     expire_in: 1 day

# build_image:
#   stage: package
#   dependencies:
#     - build_code
#   variables:
#     TO: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA
#     GIT_SUBMODULE_STRATEGY: recursive
# #   only:
# #     changes:
# #       - source
#   tags:
#     - docker-image-build
#   script:
#     - ignore
    
#run_DHNLAlgorithm:
#  stage: run
#  dependencies:
#  #  - build_image
#  # image: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA
#  image: gitlab-registry.cern.ch/atlas-phys/exot/ueh/exot-2017-19/dhnlalgorithm:feature-add-ci-72841c16
#  before_script:
#    - printf $SERVICE_PASS | kinit $CERN_USER@CERN.CH
#  script:
#    - source /release_setup.sh
#    - source /code/build/*/setup.sh
#    - cd ci
#    - bash run.sh
#  artifacts:
#    paths:
#      - ci/testRun
#    expire_in: 1 week

histograms: 
  stage: histograms
  dependencies: 
   # - run_DHNLAlgorithm
  image: rootproject/root-conda:6.18.04
  before_script:
    - cd $WORKDIR/ci
    - printf $SERVICE_PASS | kinit $CERN_USER@CERN.CH
  script: 
    - bash import_checkpoint.sh
    - python histograms.py files.root checkpoint_files.root hists.root
    - mkdir plots
    - python plots.py hists.root plots
  artifacts: 
    paths: 
      - $WORKDIR/ci/hists.root
      - $WORKDIR/ci/plots
    expire_in: 1 week

test_emptiness:
  stage: test
  dependencies:
    - histograms
  image: rootproject/root-conda:6.18.04
  before_script:
    - cd $WORKDIR/ci/test
  script:
    - python test_emptiness.py ../hists.root

upload_tests:
  stage: upload
  dependencies: 
    #- run_DHNLAlgorithm
    - histograms
  image: rootproject/root-conda:6.18.04
  before_script:
    - cd $WORKDIR/ci
    - printf $SERVICE_PASS | kinit $CERN_USER@CERN.CH
  script:
    - bash upload.sh
